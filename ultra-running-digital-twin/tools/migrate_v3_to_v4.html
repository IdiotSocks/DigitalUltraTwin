<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Ultra Twin - v3 to v4 Migration Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: rgba(249, 250, 251, 0.8);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .upload-area.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 16px;
      color: #374151;
      margin-bottom: 5px;
    }

    .upload-subtext {
      font-size: 12px;
      color: #9ca3af;
    }

    input[type="file"] {
      display: none;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid #3b82f6;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid #f59e0b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .success-box {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid #10b981;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .error-box {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .box-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .box-content {
      font-size: 13px;
      line-height: 1.6;
      color: #4b5563;
    }

    .box-content ul {
      margin-top: 8px;
      margin-left: 20px;
    }

    .box-content li {
      margin-bottom: 4px;
    }

    .profile-info {
      background: rgba(249, 250, 251, 0.8);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      font-size: 11px;
      text-transform: uppercase;
      color: #9ca3af;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 16px;
      color: #374151;
      font-weight: 600;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .file-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .file-name {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }

    .file-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .status-ready {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }

    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ v3 ‚Üí v4 Migration Tool</h1>
    <p class="subtitle">Convert your monolithic v3 profile to modular v4 architecture</p>

    <div class="info-box">
      <div class="box-title">üìã What this tool does</div>
      <div class="box-content">
        This migration tool automatically converts your Digital Ultra Twin v3 profile (single JSON file) into the new v4 modular architecture:
        <ul>
          <li><strong>athlete_state.json</strong> - Slow-changing physiological truth</li>
          <li><strong>performance_model.json</strong> - Speeds, calibration, race history</li>
          <li><strong>failure_model.json</strong> - Failure mode probabilities</li>
          <li><strong>race_context_*.json</strong> - Individual race contexts (optional)</li>
        </ul>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="section">
      <div class="section-title">
        <span>üìÅ</span>
        <span>1. Upload v3 Profile</span>
      </div>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì§</div>
        <div class="upload-text">Click to upload or drag & drop</div>
        <div class="upload-subtext">v3 athlete profile JSON file</div>
      </div>
      <input type="file" id="v3Input" accept=".json">
    </div>

    <!-- Profile Info Section (hidden initially) -->
    <div class="section" id="profileSection" style="display: none;">
      <div class="section-title">
        <span>üë§</span>
        <span>2. Profile Information</span>
      </div>
      <div class="profile-info" id="profileInfo"></div>
    </div>

    <!-- Options Section (hidden initially) -->
    <div class="section" id="optionsSection" style="display: none;">
      <div class="section-title">
        <span>‚öôÔ∏è</span>
        <span>3. Migration Options</span>
      </div>
      <div class="options">
        <label class="checkbox-label">
          <input type="checkbox" id="optionRaceContexts" checked>
          <span>Create race_context_*.json files for each race in history</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="optionUncertainty" checked>
          <span>Generate uncertainty.json with variance models</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="optionCounterHypotheses">
          <span>Generate counter_hypotheses.json template</span>
        </label>
      </div>
    </div>

    <!-- Action Section (hidden initially) -->
    <div class="section" id="actionSection" style="display: none;">
      <div class="section-title">
        <span>üöÄ</span>
        <span>4. Migrate & Download</span>
      </div>
      <div class="action-buttons">
        <button class="btn btn-success" onclick="performMigration()">
          ‚ú® Migrate to v4
        </button>
        <button class="btn" onclick="resetTool()" style="background: #6b7280;">
          üîÑ Start Over
        </button>
      </div>
    </div>

    <!-- Results Section (hidden initially) -->
    <div class="section" id="resultsSection" style="display: none;">
      <div class="section-title">
        <span>‚úÖ</span>
        <span>Migration Complete</span>
      </div>
      <div class="success-box">
        <div class="box-title">Successfully migrated to v4!</div>
        <div class="box-content">
          The following files have been downloaded to your computer:
        </div>
      </div>
      <div class="file-list" id="fileList"></div>
    </div>

    <div class="footer">
      Digital Ultra Twin v4.0 | Migration Tool | 2026
    </div>
  </div>

  <script>
    let v3Profile = null;

    // Upload area interactions
    const uploadArea = document.getElementById('uploadArea');
    const v3Input = document.getElementById('v3Input');

    uploadArea.addEventListener('click', () => v3Input.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        loadV3Profile(file);
      }
    });

    v3Input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        loadV3Profile(file);
      }
    });

    function loadV3Profile(file) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          v3Profile = JSON.parse(evt.target.result);
          console.log('‚úÖ v3 Profile loaded:', v3Profile);
          displayProfileInfo();
          document.getElementById('profileSection').style.display = 'block';
          document.getElementById('optionsSection').style.display = 'block';
          document.getElementById('actionSection').style.display = 'block';
          uploadArea.innerHTML = `
            <div class="upload-icon">‚úÖ</div>
            <div class="upload-text" style="color: #10b981;">${file.name}</div>
            <div class="upload-subtext">Profile loaded successfully</div>
          `;
        } catch (err) {
          alert('‚ùå Error loading v3 profile:\n\n' + err.message);
          console.error('Error:', err);
        }
      };
      reader.readAsText(file);
    }

    function displayProfileInfo() {
      const info = v3Profile.athlete_info || {};
      const perf = v3Profile.performance_by_gradient || {};
      const calibration = v3Profile.calibration || {};
      const raceHistory = info.race_history || [];

      const html = `
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Athlete Name</div>
            <div class="info-value">${info.name || 'Not specified'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Profile Version</div>
            <div class="info-value">v${v3Profile.version || '3.x'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Races in History</div>
            <div class="info-value">${raceHistory.length} races</div>
          </div>
          <div class="info-item">
            <div class="info-label">Calibration Status</div>
            <div class="info-value">${calibration.overall_factor ? 'Calibrated' : 'Not calibrated'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Base Speeds</div>
            <div class="info-value">${Object.keys(perf).length} gradients</div>
          </div>
          <div class="info-item">
            <div class="info-label">Last Updated</div>
            <div class="info-value">${v3Profile.metadata?.last_updated || 'Unknown'}</div>
          </div>
        </div>
      `;

      document.getElementById('profileInfo').innerHTML = html;
    }

    function performMigration() {
      if (!v3Profile) {
        alert('No profile loaded');
        return;
      }

      console.log('üîÑ Starting migration...');

      const athleteName = v3Profile.athlete_info?.name?.toLowerCase().replace(/\s+/g, '_') || 'athlete';
      const today = new Date().toISOString().split('T')[0];
      const generatedFiles = [];

      // ========== 1. Create athlete_state.json ==========
      const athleteState = {
        metadata: {
          athlete_id: athleteName,
          version: '4.0',
          last_updated: today,
          update_cadence: 'monthly',
          notes: 'Migrated from v3 profile',
          migration_date: today
        },
        physiology: {
          vo2_max: {
            estimate_ml_kg_min: v3Profile.physiological_profile?.vo2_max || 57,
            method: 'estimated_from_race_performance'
          },
          heart_rate: {
            max_hr: v3Profile.physiological_profile?.max_hr || 185,
            threshold_hr: v3Profile.physiological_profile?.threshold_hr || 168,
            resting_hr: v3Profile.physiological_profile?.resting_hr || 48
          },
          running_economy: v3Profile.physiological_profile?.running_economy || 'good'
        },
        respiratory_profile: v3Profile.respiratory_profile || {
          condition: 'none',
          temperature_thresholds: {
            high_risk_c: null,
            moderate_risk_c: null,
            optimal_min_c: 12,
            optimal_max_c: 20
          },
          management: {
            hr_discipline: false,
            inhaler_use: false
          }
        },
        technical_skill: {
          overall: v3Profile.technical_terrain_capability?.overall_rating || 'good',
          relative_percentile_gain: (() => {
            const advantage = v3Profile.technical_terrain_capability?.competitive_advantage;
            if (advantage && advantage.includes('+')) {
              const match = advantage.match(/\+(\d+)/);
              return match ? parseInt(match[1]) : 0;
            }
            return 0;
          })(),
          terrain_types: v3Profile.technical_terrain_capability?.terrain_types || [],
          description: v3Profile.technical_terrain_capability?.description || ''
        },
        injury_profile: v3Profile.injury_history_and_resilience || {
          current_injuries: [],
          chronic_issues: [],
          injury_risk_areas: [],
          resilience_rating: 'good'
        }
      };

      generatedFiles.push({ name: `${athleteName}_athlete_state.json`, data: athleteState });

      // ========== 2. Create performance_model.json ==========
      const performanceModel = {
        model_version: '4.0',
        fitness_anchor: v3Profile.fitness_baseline || {
          baseline_race: 'Not set',
          baseline_ctl: 100,
          baseline_fitness: 1.0,
          baseline_date: today
        },
        gradient_speeds: {},
        terrain_multipliers: {
          road: 1.0,
          runnable_trail: 0.96,
          technical_dry: 0.90,
          technical_wet: 0.82,
          mud: 0.85,
          snow: 0.78,
          sand: 0.75
        },
        environmental_penalties: {
          heat: {
            '>25c': 0.92,
            '>30c': 0.85,
            '>35c': 0.75
          },
          cold: {
            '<0c': 0.92,
            '<-10c': 0.85
          },
          wind: {
            'strong_headwind': 0.94,
            'very_strong': 0.88
          },
          altitude: {
            '2000-3000m': 0.95,
            '3000-4000m': 0.88,
            '>4000m': 0.78
          }
        },
        fatigue_model: {
          inflection_distance_km: 55,
          fade_rate_per_km: 0.003,
          max_fade_factor: 0.80
        },
        calibration: v3Profile.calibration || {
          overall_factor: 1.0,
          by_course_type: {},
          races_used: 0,
          last_calibrated: today
        },
        race_history: (v3Profile.athlete_info?.race_history || []).map((race, index) => ({
          rank: race.rank || index + 1,
          race: race.race,
          date: race.date,
          type: race.type,
          distance_km: race.distance_km,
          elevation_m: race.elevation_m,
          finish_time: race.finish_time,
          fitness_level: race.fitness_level,
          ctl: race.ctl,
          percentile: race.percentile,
          conditions: race.conditions,
          notes: race.notes,
          status: race.status
        }))
      };

      // Convert v3 performance_by_gradient to v4 gradient_speeds
      const perf = v3Profile.performance_by_gradient || {};
      const gradientMapping = {
        'steep_downhill': { range: [-50, -15], category: 'steep_downhill' },
        'moderate_downhill': { range: [-15, -5], category: 'moderate_downhill' },
        'flat': { range: [-5, 5], category: 'flat' },
        'moderate_uphill': { range: [5, 15], category: 'moderate_uphill' },
        'steep_uphill': { range: [15, 50], category: 'steep_uphill' }
      };

      Object.entries(gradientMapping).forEach(([key, config]) => {
        const v3Data = perf[key];
        let meanSpeed = 6.0; // fallback

        // Try different possible property names in v3
        if (v3Data) {
          if (v3Data.speed_kmh) {
            meanSpeed = v3Data.speed_kmh;
          } else if (v3Data.kmh) {
            meanSpeed = v3Data.kmh;
          } else if (v3Data.mean) {
            meanSpeed = v3Data.mean;
          } else if (typeof v3Data === 'number') {
            meanSpeed = v3Data;
          }
        }

        performanceModel.gradient_speeds[config.category] = {
          range_pct: config.range,
          kmh: {
            mean: parseFloat(meanSpeed.toFixed(2)),
            p10: parseFloat((meanSpeed * 0.91).toFixed(2)),
            p90: parseFloat((meanSpeed * 1.09).toFixed(2))
          }
        };
      });

      generatedFiles.push({ name: `${athleteName}_performance_model.json`, data: performanceModel });

      // ========== 3. Create failure_model.json ==========
      const failureModel = {
        model_version: '4.0',
        failure_modes: {
          respiratory: {
            condition: athleteState.respiratory_profile?.condition || 'none',
            incident_probability: (() => {
              const highRisk = athleteState.respiratory_profile?.temperature_thresholds?.high_risk_c;
              const modRisk = athleteState.respiratory_profile?.temperature_thresholds?.moderate_risk_c;
              if (highRisk && modRisk) {
                return {
                  [`<${highRisk}c`]: 0.35,
                  [`${highRisk}-${modRisk}c`]: 0.18,
                  [`${modRisk}-12c`]: 0.08,
                  '>=12c': 0.05
                };
              }
              return {
                '<8c': 0.35,
                '8-10c': 0.18,
                '10-12c': 0.08,
                '>=12c': 0.05
              };
            })(),
            vulnerable_window_km: [5, 25],
            recovery_probability: 0.67,
            impact_if_triggered: {
              pace_multiplier: 0.85,
              duration_minutes: [10, 40]
            },
            mitigation: {
              hr_discipline_below: 150,
              inhaler_prerace: true,
              warmup_critical: true
            }
          },
          nutrition: {
            bonk_probability_by_intake: {
              '<40gh': 0.60,
              '40-60gh': 0.25,
              '60-80gh': 0.10,
              '>=80gh': 0.05
            },
            gi_distress_probability: {
              '<60gh': 0.05,
              '60-90gh': 0.10,
              '>90gh': 0.25
            },
            impact: {
              bonk_pace_multiplier: 0.65,
              gi_pace_multiplier: 0.80
            }
          },
          musculoskeletal: {
            injury_risk_areas: athleteState.injury_profile?.injury_risk_areas || [],
            chronic_issues: athleteState.injury_profile?.chronic_issues || [],
            fatigue_injury_probability: {
              'first_50km': 0.02,
              '50-80km': 0.05,
              '>80km': 0.12
            }
          }
        }
      };

      generatedFiles.push({ name: `${athleteName}_failure_model.json`, data: failureModel });

      // ========== 4. Create race_context files (optional) ==========
      if (document.getElementById('optionRaceContexts').checked) {
        const raceHistory = v3Profile.athlete_info?.race_history || [];
        raceHistory.forEach((race, index) => {
          if (race.race && race.date) {
            const raceId = race.race.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            const raceContext = {
              race: race.race,
              race_id: raceId,
              date: race.date,
              distance_km: race.distance_km,
              elevation_m: race.elevation_m,
              course_profile: race.type || 'trail',
              expected_conditions: {
                temperature_c: race.conditions ? [parseInt(race.conditions), parseInt(race.conditions) + 5] : [10, 15],
                wind: 'moderate',
                surface: 'dry_trail',
                daylight: 'full'
              },
              fitness_target: race.fitness_level || 1.0,
              target_ctl: race.ctl || 100,
              goals: {
                primary: 'finish_strong',
                secondary: race.notes || 'none'
              },
              actual_result: {
                finish_time: race.finish_time,
                percentile: race.percentile,
                status: race.status || 'completed'
              }
            };
            generatedFiles.push({ name: `${athleteName}_race_context_${raceId}.json`, data: raceContext });
          }
        });
      }

      // ========== 5. Create uncertainty.json (optional) ==========
      if (document.getElementById('optionUncertainty').checked) {
        const uncertainty = {
          model_version: '4.0',
          uncertainty_model: {
            physiology: {
              vo2_max: {
                mean: athleteState.physiology.vo2_max.estimate_ml_kg_min,
                sd: 2.5,
                confidence: 'medium'
              },
              threshold_hr: {
                mean: athleteState.physiology.heart_rate.threshold_hr,
                sd: 4
              }
            },
            performance: {
              gradient_speed_variance: 0.06,
              fatigue_variance: 0.04,
              terrain_multiplier_variance: 0.03
            },
            environment: {
              temperature_forecast_error_c: 2,
              wind_forecast_error_kmh: 5,
              precipitation_uncertainty: 'high'
            },
            race_day: {
              pacing_execution_variance: 0.05,
              nutrition_execution_variance: 0.10
            }
          }
        };
        generatedFiles.push({ name: `${athleteName}_uncertainty.json`, data: uncertainty });
      }

      // ========== 6. Create counter_hypotheses.json (optional) ==========
      if (document.getElementById('optionCounterHypotheses').checked) {
        const counterHypotheses = {
          model_version: '4.0',
          counter_hypotheses: [
            {
              claim: 'Current calibration factors are accurate',
              evidence_for: [
                `Calibrated on ${performanceModel.calibration.races_used} races`,
                `Overall factor: ${performanceModel.calibration.overall_factor}`
              ],
              could_be_wrong_if: [
                'fitness level changes significantly',
                'new race types with different characteristics',
                'environmental conditions outside training range'
              ],
              disproving_data_needed: [
                'prediction error >20% on multiple similar races',
                'systematic over/under-prediction pattern'
              ]
            }
          ]
        };
        generatedFiles.push({ name: `${athleteName}_counter_hypotheses.json`, data: counterHypotheses });
      }

      // ========== Download all files ==========
      console.log(`üì¶ Generating ${generatedFiles.length} files...`);

      generatedFiles.forEach((file, index) => {
        setTimeout(() => {
          downloadJSON(file.data, file.name);
          console.log(`‚úÖ Downloaded: ${file.name}`);
        }, index * 150); // 150ms delay between downloads
      });

      // Show results
      displayResults(generatedFiles);
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function displayResults(files) {
      document.getElementById('resultsSection').style.display = 'block';

      const fileListHTML = files.map(file => `
        <div class="file-item">
          <div class="file-name">üìÑ ${file.name}</div>
          <div class="file-status status-ready">Downloaded</div>
        </div>
      `).join('');

      document.getElementById('fileList').innerHTML = fileListHTML;

      // Scroll to results
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    function resetTool() {
      v3Profile = null;
      document.getElementById('profileSection').style.display = 'none';
      document.getElementById('optionsSection').style.display = 'none';
      document.getElementById('actionSection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('v3Input').value = '';
      uploadArea.innerHTML = `
        <div class="upload-icon">üì§</div>
        <div class="upload-text">Click to upload or drag & drop</div>
        <div class="upload-subtext">v3 athlete profile JSON file</div>
      `;
    }
  </script>
</body>
</html>
