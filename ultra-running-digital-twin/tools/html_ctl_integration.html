<!-- Add this section after your "2. Training Inputs" card and before "3. Strategy" -->

<div class="card border-l-4 border-emerald-500 space-y-3">
  <h2 class="font-bold text-sm text-slate-900 uppercase">üìä CTL Fitness Tracker</h2>

  <div>
    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Current CTL</label>
    <input type="number" id="ctlCurrent" value="106" class="w-full p-1 border rounded text-sm font-bold text-emerald-700">
  </div>

  <div>
    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Race Date</label>
    <input type="date" id="raceDate" class="w-full p-1 border rounded text-sm">
  </div>

  <div>
    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Training Plan</label>
    <select id="trainingPlan" onchange="updateCTLProjection()" class="w-full p-1 border rounded text-xs font-bold text-slate-700">
      <option value="2.5">Conservative (2.5 CTL/week)</option>
      <option value="3.5" selected>Moderate (3.5 CTL/week)</option>
      <option value="5.0">Aggressive (5.0 CTL/week)</option>
      <option value="0">Maintenance (0 CTL/week)</option>
    </select>
  </div>

  <div class="text-[10px] text-slate-400 pt-2 border-t space-y-1">
    <div class="flex justify-between">
      <span>Weeks to Race:</span>
      <span id="ctlWeeksToRace" class="font-bold text-slate-600">--</span>
    </div>
    <div class="flex justify-between">
      <span>Peak CTL:</span>
      <span id="ctlPeak" class="font-bold text-emerald-600">--</span>
    </div>
    <div class="flex justify-between">
      <span>Race Day CTL:</span>
      <span id="ctlRaceDay" class="font-bold text-emerald-700">--</span>
    </div>
    <div class="flex justify-between">
      <span>Race Day Fitness:</span>
      <span id="ctlFitness" class="font-bold text-green-600">--</span>
    </div>
  </div>

  <button onclick="showCTLScenarios()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2 rounded">
    üìà Compare Scenarios
  </button>
</div>

<!-- CTL Scenarios Modal (add before closing </body> tag) -->
<div id="ctlModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
  <div style="max-width: 800px; margin: 40px auto; background: white; border-radius: 12px; padding: 30px;">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-slate-900">CTL Training Scenarios</h2>
      <button onclick="document.getElementById('ctlModal').style.display='none'" class="text-slate-500 hover:text-slate-700 text-2xl font-bold">&times;</button>
    </div>

    <div id="ctlScenariosContent" class="space-y-4">
      <!-- Scenarios will be inserted here -->
    </div>
  </div>
</div>

<script>
// Add these functions to your existing <script> section

// CTL to Fitness conversion (calibrated: CTL 120 = Fitness 1.0, CTL 187 = Fitness 1.558)
const CTL_BASELINE = 120;
const CTL_TO_FITNESS_RATE = 0.00833;

function ctlToFitness(ctl) {
  const fitness = 1.0 + ((ctl - CTL_BASELINE) * CTL_TO_FITNESS_RATE);
  return Math.max(0.5, fitness);
}

function fitnessToCtl(fitness) {
  return CTL_BASELINE + ((fitness - 1.0) / CTL_TO_FITNESS_RATE);
}

function calculateWeeksToRace() {
  const raceDateInput = document.getElementById('raceDate');
  if (!raceDateInput.value) return 0;

  const today = new Date();
  const raceDate = new Date(raceDateInput.value);
  const diffTime = raceDate - today;
  const diffDays = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
  return diffDays / 7;
}

function updateCTLProjection() {
  const currentCtl = parseFloat(document.getElementById('ctlCurrent').value) || 106;
  const weeksToRace = calculateWeeksToRace();
  const weeklyGain = parseFloat(document.getElementById('trainingPlan').value) || 3.5;

  document.getElementById('ctlWeeksToRace').innerText = weeksToRace.toFixed(1);

  if (weeksToRace === 0) {
    document.getElementById('ctlPeak').innerText = currentCtl.toFixed(0);
    document.getElementById('ctlRaceDay').innerText = currentCtl.toFixed(0);
    document.getElementById('ctlFitness').innerText = ctlToFitness(currentCtl).toFixed(3);
    return;
  }

  // Calculate with 2-week taper
  const taperWeeks = Math.min(2, weeksToRace);
  const buildWeeks = Math.max(0, weeksToRace - taperWeeks);

  const peakCtl = currentCtl + (buildWeeks * weeklyGain);
  const raceDayCtl = peakCtl - (taperWeeks * 2); // Lose 2 CTL/week during taper
  const raceDayFitness = ctlToFitness(raceDayCtl);

  document.getElementById('ctlPeak').innerText = peakCtl.toFixed(0);
  document.getElementById('ctlRaceDay').innerText = raceDayCtl.toFixed(0);
  document.getElementById('ctlFitness').innerText = raceDayFitness.toFixed(3);

  // Update the old fitness level display to match CTL
  const fitEl = document.getElementById('fitnessLevel');
  if (fitEl) fitEl.innerText = raceDayFitness.toFixed(2);
}

// Set default race date to 8 weeks from now
(function setDefaultRaceDate() {
  const today = new Date();
  const futureDate = new Date(today.getTime() + (8 * 7 * 24 * 60 * 60 * 1000));
  const dateStr = futureDate.toISOString().split('T')[0];
  document.getElementById('raceDate').value = dateStr;
  updateCTLProjection();
})();

// Update CTL projection when inputs change
document.getElementById('ctlCurrent').addEventListener('input', updateCTLProjection);
document.getElementById('raceDate').addEventListener('change', updateCTLProjection);

function showCTLScenarios() {
  const currentCtl = parseFloat(document.getElementById('ctlCurrent').value) || 106;
  const weeksToRace = calculateWeeksToRace();

  if (weeksToRace === 0) {
    alert('Please set a race date first!');
    return;
  }

  const taperWeeks = Math.min(2, weeksToRace);
  const buildWeeks = Math.max(0, weeksToRace - taperWeeks);

  const scenarios = [
    { name: 'Current Fitness (No Training)', ctl: currentCtl, plan: 0 },
    { name: 'Conservative Training', ctl: currentCtl + (buildWeeks * 2.5) - (taperWeeks * 2), plan: 2.5 },
    { name: 'Moderate Training', ctl: currentCtl + (buildWeeks * 3.5) - (taperWeeks * 2), plan: 3.5 },
    { name: 'Aggressive Training', ctl: currentCtl + (buildWeeks * 5.0) - (taperWeeks * 2), plan: 5.0 }
  ];

  let html = `
    <div class="mb-4 p-4 bg-slate-50 rounded">
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><strong>Current CTL:</strong> ${currentCtl.toFixed(0)}</div>
        <div><strong>Weeks to Race:</strong> ${weeksToRace.toFixed(1)}</div>
        <div><strong>Build Weeks:</strong> ${buildWeeks.toFixed(1)}</div>
        <div><strong>Taper Weeks:</strong> ${taperWeeks.toFixed(1)}</div>
      </div>
    </div>

    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="bg-slate-100">
          <th class="p-2 text-left border-b-2">Scenario</th>
          <th class="p-2 text-center border-b-2">Race CTL</th>
          <th class="p-2 text-center border-b-2">Fitness</th>
          <th class="p-2 text-center border-b-2">CTL Gain</th>
          <th class="p-2 text-center border-b-2">Action</th>
        </tr>
      </thead>
      <tbody>
  `;

  scenarios.forEach((s, idx) => {
    const fitness = ctlToFitness(s.ctl);
    const gain = s.ctl - currentCtl;
    const gainClass = gain > 0 ? 'text-green-600' : 'text-slate-500';

    html += `
      <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
        <td class="p-2 border-b font-medium">${s.name}</td>
        <td class="p-2 border-b text-center font-bold text-emerald-600">${s.ctl.toFixed(0)}</td>
        <td class="p-2 border-b text-center font-bold text-green-600">${fitness.toFixed(3)}</td>
        <td class="p-2 border-b text-center ${gainClass} font-bold">${gain >= 0 ? '+' : ''}${gain.toFixed(1)}</td>
        <td class="p-2 border-b text-center">
          <button onclick="applyCTLScenario(${s.ctl.toFixed(1)}, ${s.plan})"
            class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded">
            Use This
          </button>
        </td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>

    <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-600 text-xs text-slate-700">
      <strong>üìù Note:</strong> All scenarios include a 2-week taper period (-2 CTL/week).
      Click "Use This" to apply that fitness level to your current race prediction.
    </div>
  `;

  document.getElementById('ctlScenariosContent').innerHTML = html;
  document.getElementById('ctlModal').style.display = 'block';
}

function applyCTLScenario(ctl, plan) {
  document.getElementById('ctlCurrent').value = ctl;
  document.getElementById('trainingPlan').value = plan;
  updateCTLProjection();
  document.getElementById('ctlModal').style.display = 'none';

  log('Applied CTL scenario: ' + ctl.toFixed(0) + ' (Fitness: ' + ctlToFitness(ctl).toFixed(3) + ')', 'success');

  // Automatically re-run analysis with new fitness
  if (currentCourse && currentCourse.length > 0) {
    runAnalysis();
  }
}

// Modify your existing runAnalysis function to use CTL fitness
// Find this section in your runAnalysis function and replace the fitness calculation:
/*
// OLD CODE (around line 570):
var projCTL = ctl + (weeks * ramp);
var fitness = 1.10 + ((projCTL - 150) * 0.0025);
if(fitness < 1.0) fitness = 1.0;
if(fitness > 1.5) fitness = 1.5;

// REPLACE WITH:
var raceDayCtl = parseFloat(document.getElementById('ctlRaceDay').innerText.replace('--', '0')) || 120;
var fitness = ctlToFitness(raceDayCtl);
*/
</script>
