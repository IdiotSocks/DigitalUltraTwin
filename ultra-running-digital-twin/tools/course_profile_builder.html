<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultra Course Profile Builder</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 32px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .form-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }

    input, select, textarea {
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-add {
      background: #10b981;
      color: white;
      width: 100%;
      margin-top: 10px;
    }

    .aid-station-item, .segment-item {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid #e5e7eb;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .item-title {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    .checkbox-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .checkbox-label input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .output-section {
      background: #1f2937;
      border-radius: 16px;
      padding: 30px;
      margin-top: 20px;
    }

    .output-title {
      color: white;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    #jsonOutput {
      background: #111827;
      color: #10b981;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 500px;
      overflow-y: auto;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .help-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÉ Ultra Course Profile Builder</h1>

    <form id="courseForm">
      <!-- Course Metadata -->
      <div class="form-card">
        <div class="section-title">üìã Course Metadata</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Race ID *</label>
            <input type="text" name="race_id" required placeholder="arc_25">
            <div class="help-text">Lowercase slug: race_name_distance</div>
          </div>
          <div class="form-group">
            <label>Race Name *</label>
            <input type="text" name="race_name" required placeholder="Arc of Attrition 25">
          </div>
          <div class="form-group">
            <label>Distance (km) *</label>
            <input type="number" name="distance_km" step="0.1" required placeholder="40.0">
          </div>
          <div class="form-group">
            <label>Elevation Gain (m) *</label>
            <input type="number" name="elevation_gain_m" required placeholder="2300">
          </div>
          <div class="form-group">
            <label>Elevation Loss (m)</label>
            <input type="number" name="elevation_loss_m" placeholder="2300">
          </div>
          <div class="form-group">
            <label>Region *</label>
            <input type="text" name="region" required placeholder="Cornwall, UK">
          </div>
          <div class="form-group">
            <label>Course Type *</label>
            <select name="course_type" required>
              <option value="">Select type...</option>
              <option value="runnable_trail_hilly">Runnable Trail (Hilly)</option>
              <option value="technical_coastal_trail">Technical Coastal Trail</option>
              <option value="alpine_ultra">Alpine Ultra</option>
              <option value="mountain_sky_running">Mountain Sky Running</option>
              <option value="desert_ultra">Desert Ultra</option>
              <option value="forest_trail_moderate">Forest Trail (Moderate)</option>
              <option value="fell_running_uk">Fell Running (UK)</option>
              <option value="road_ultra">Road Ultra</option>
              <option value="gravel_ultra">Gravel Ultra</option>
              <option value="canyon_technical">Canyon Technical</option>
              <option value="night_only_ultra">Night Only Ultra</option>
              <option value="multi_loop_course">Multi-Loop Course</option>
            </select>
          </div>
          <div class="form-group">
            <label>Start Time</label>
            <input type="time" name="start_time" value="06:00">
          </div>
          <div class="form-group">
            <label>Cutoff (hours)</label>
            <input type="number" name="cutoff_hours" step="0.5" placeholder="12.0">
          </div>
          <div class="form-group">
            <label>Loop Type</label>
            <select name="loop_type">
              <option value="point_to_point">Point to Point</option>
              <option value="out_and_back">Out and Back</option>
              <option value="loop">Loop</option>
              <option value="multi_loop">Multi-Loop</option>
            </select>
          </div>
          <div class="form-group">
            <label>Exposure Rating</label>
            <select name="exposure_rating">
              <option value="low">Low</option>
              <option value="moderate">Moderate</option>
              <option value="high">High</option>
              <option value="extreme">Extreme</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea name="notes" placeholder="Key race characteristics..."></textarea>
        </div>
      </div>

      <!-- Environment Profile -->
      <div class="form-card">
        <div class="section-title">üå§Ô∏è Environment Profile</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Min Altitude (m)</label>
            <input type="number" name="altitude_min" placeholder="0">
          </div>
          <div class="form-group">
            <label>Max Altitude (m)</label>
            <input type="number" name="altitude_max" placeholder="300">
          </div>
          <div class="form-group">
            <label>Min Temp (¬∞C)</label>
            <input type="number" name="temp_min" placeholder="5">
          </div>
          <div class="form-group">
            <label>Max Temp (¬∞C)</label>
            <input type="number" name="temp_max" placeholder="12">
          </div>
          <div class="form-group">
            <label>Min Wind (km/h)</label>
            <input type="number" name="wind_min" placeholder="10">
          </div>
          <div class="form-group">
            <label>Max Wind (km/h)</label>
            <input type="number" name="wind_max" placeholder="40">
          </div>
        </div>
      </div>

      <!-- Terrain Profile -->
      <div class="form-card">
        <div class="section-title">‚õ∞Ô∏è Terrain Profile</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Paved (%)</label>
            <input type="number" name="paved_pct" min="0" max="100" placeholder="15">
          </div>
          <div class="form-group">
            <label>Gravel/Track (%)</label>
            <input type="number" name="gravel_pct" min="0" max="100" placeholder="0">
          </div>
          <div class="form-group">
            <label>Singletrack (%)</label>
            <input type="number" name="singletrack_pct" min="0" max="100" placeholder="30">
          </div>
          <div class="form-group">
            <label>Rocky Technical (%)</label>
            <input type="number" name="rocky_pct" min="0" max="100" placeholder="40">
          </div>
          <div class="form-group">
            <label>Bog/Mud (%)</label>
            <input type="number" name="bog_pct" min="0" max="100" placeholder="10">
          </div>
          <div class="form-group">
            <label>Sand (%)</label>
            <input type="number" name="sand_pct" min="0" max="100" placeholder="5">
          </div>
          <div class="form-group">
            <label>Runnable Fraction</label>
            <input type="number" name="runnable_fraction" step="0.01" min="0" max="1" placeholder="0.45">
            <div class="help-text">0.0 to 1.0 (0.45 = 45% runnable)</div>
          </div>
          <div class="form-group">
            <label>Dry Multiplier</label>
            <input type="number" name="dry_multiplier" step="0.01" min="0" max="1" placeholder="0.92">
            <div class="help-text">Speed relative to road (0.92 = 8% slower)</div>
          </div>
        </div>
      </div>

      <!-- Aid Stations -->
      <div class="form-card">
        <div class="section-title">üèÅ Aid Stations</div>
        <div id="aidStationsContainer"></div>
        <button type="button" class="btn btn-add" onclick="addAidStation()">‚ûï Add Aid Station</button>
      </div>

      <!-- Key Segments -->
      <div class="form-card">
        <div class="section-title">üìç Key Segments</div>
        <div id="segmentsContainer"></div>
        <button type="button" class="btn btn-add" onclick="addSegment()">‚ûï Add Segment</button>
      </div>

      <!-- Generate Button -->
      <div class="form-card">
        <button type="button" class="btn btn-primary" onclick="generateJSON()" style="width: 100%;">
          üöÄ Generate Course Profile JSON
        </button>
      </div>
    </form>

    <!-- Output -->
    <div class="output-section">
      <div class="output-title">üìÑ Generated JSON</div>
      <div id="jsonOutput">JSON will appear here after you click "Generate Course Profile JSON"</div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="copyJSON()">üìã Copy to Clipboard</button>
        <button class="btn btn-secondary" onclick="downloadJSON()">üíæ Download JSON</button>
      </div>
    </div>
  </div>

  <script>
    let aidStationCount = 0;
    let segmentCount = 0;
    let generatedJSON = null;

    function addAidStation() {
      aidStationCount++;
      const container = document.getElementById('aidStationsContainer');
      const div = document.createElement('div');
      div.className = 'aid-station-item';
      div.id = `aid-${aidStationCount}`;

      div.innerHTML = `
        <div class="item-header">
          <div class="item-title">Aid Station ${aidStationCount}</div>
          <button type="button" class="btn btn-danger" onclick="removeAidStation(${aidStationCount})">Remove</button>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" name="aid_name_${aidStationCount}" required placeholder="CP1 - Widemouth Bay">
          </div>
          <div class="form-group">
            <label>Distance (km) *</label>
            <input type="number" name="aid_distance_${aidStationCount}" step="0.1" required placeholder="8.5">
          </div>
          <div class="form-group">
            <label>Elevation (m)</label>
            <input type="number" name="aid_elevation_${aidStationCount}" placeholder="50">
          </div>
          <div class="form-group">
            <label>Type</label>
            <select name="aid_type_${aidStationCount}">
              <option value="aid">Aid Station</option>
              <option value="crew">Crew Access</option>
              <option value="drop_bag">Drop Bag</option>
              <option value="water_only">Water Only</option>
              <option value="start">Start</option>
              <option value="finish">Finish</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estimated Stop (seconds)</label>
            <input type="number" name="aid_estimated_${aidStationCount}" placeholder="60">
          </div>
          <div class="form-group">
            <label>Target Stop (seconds)</label>
            <input type="number" name="aid_target_${aidStationCount}" placeholder="45">
          </div>
          <div class="form-group">
            <label>Cutoff Time</label>
            <input type="time" name="aid_cutoff_${aidStationCount}" placeholder="10:00">
          </div>
          <div class="form-group">
            <label>Buffer to Cutoff (min)</label>
            <input type="number" name="aid_buffer_${aidStationCount}" placeholder="60">
          </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label>Features</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="aid_crew_${aidStationCount}"> Crew Access
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="aid_dropbag_${aidStationCount}"> Drop Bag
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="aid_fullaid_${aidStationCount}"> Full Aid
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="aid_medical_${aidStationCount}"> Medical
            </label>
          </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label>Crew Instructions</label>
          <textarea name="aid_crew_instructions_${aidStationCount}" placeholder="What should crew prepare?"></textarea>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label>Notes</label>
          <textarea name="aid_notes_${aidStationCount}" placeholder="Special considerations..."></textarea>
        </div>
      `;

      container.appendChild(div);
    }

    function removeAidStation(id) {
      document.getElementById(`aid-${id}`).remove();
    }

    function addSegment() {
      segmentCount++;
      const container = document.getElementById('segmentsContainer');
      const div = document.createElement('div');
      div.className = 'segment-item';
      div.id = `segment-${segmentCount}`;

      div.innerHTML = `
        <div class="item-header">
          <div class="item-title">Segment ${segmentCount}</div>
          <button type="button" class="btn btn-danger" onclick="removeSegment(${segmentCount})">Remove</button>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" name="seg_name_${segmentCount}" required placeholder="Start to CP1">
          </div>
          <div class="form-group">
            <label>Start (km) *</label>
            <input type="number" name="seg_start_${segmentCount}" step="0.1" required placeholder="0.0">
          </div>
          <div class="form-group">
            <label>End (km) *</label>
            <input type="number" name="seg_end_${segmentCount}" step="0.1" required placeholder="8.5">
          </div>
          <div class="form-group">
            <label>Difficulty</label>
            <select name="seg_difficulty_${segmentCount}">
              <option value="easy">Easy</option>
              <option value="moderate">Moderate</option>
              <option value="hard">Hard</option>
              <option value="extreme">Extreme</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label>Description</label>
          <textarea name="seg_description_${segmentCount}" placeholder="What makes this section notable?"></textarea>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label>Strategy Notes</label>
          <textarea name="seg_strategy_${segmentCount}" placeholder="How to approach this section..."></textarea>
        </div>
      `;

      container.appendChild(div);
    }

    function removeSegment(id) {
      document.getElementById(`segment-${id}`).remove();
    }

    function generateJSON() {
      const form = document.getElementById('courseForm');
      const formData = new FormData(form);

      // Build the JSON structure
      const profile = {
        course_metadata: {
          race_id: formData.get('race_id'),
          race_name: formData.get('race_name'),
          distance_km: parseFloat(formData.get('distance_km')),
          elevation_gain_m: parseInt(formData.get('elevation_gain_m')),
          elevation_loss_m: parseInt(formData.get('elevation_loss_m')) || parseInt(formData.get('elevation_gain_m')),
          region: formData.get('region'),
          course_type: formData.get('course_type'),
          start_time: formData.get('start_time') || "06:00",
          cutoff_hours: parseFloat(formData.get('cutoff_hours')) || 0,
          loop_type: formData.get('loop_type') || "point_to_point",
          exposure_rating: formData.get('exposure_rating') || "moderate",
          notes: formData.get('notes') || "",
          version: "1.0",
          calibration_source: "Manual entry via Course Profile Builder"
        },
        environment_profile: {
          altitude_band_m: [
            parseInt(formData.get('altitude_min')) || 0,
            parseInt(formData.get('altitude_max')) || 0
          ],
          temperature_band_c: [
            parseInt(formData.get('temp_min')) || 0,
            parseInt(formData.get('temp_max')) || 0
          ],
          wind_band_kmh: [
            parseInt(formData.get('wind_min')) || 0,
            parseInt(formData.get('wind_max')) || 0
          ]
        },
        terrain_profile: {
          surface_mix: {
            paved_pct: parseInt(formData.get('paved_pct')) || 0,
            gravel_track_pct: parseInt(formData.get('gravel_pct')) || 0,
            singletrack_pct: parseInt(formData.get('singletrack_pct')) || 0,
            rocky_technical_pct: parseInt(formData.get('rocky_pct')) || 0,
            bog_mud_pct: parseInt(formData.get('bog_pct')) || 0,
            sand_pct: parseInt(formData.get('sand_pct')) || 0
          },
          technicality: {
            dry_multiplier: parseFloat(formData.get('dry_multiplier')) || 1.0
          },
          runnability: {
            runnable_fraction_estimate: parseFloat(formData.get('runnable_fraction')) || 0.5
          }
        },
        aid_stations: [],
        key_segments: []
      };

      // Collect aid stations
      for (let i = 1; i <= aidStationCount; i++) {
        if (document.getElementById(`aid-${i}`)) {
          const station = {
            name: formData.get(`aid_name_${i}`),
            distance_km: parseFloat(formData.get(`aid_distance_${i}`)),
            elevation_m: parseInt(formData.get(`aid_elevation_${i}`)) || 0,
            type: formData.get(`aid_type_${i}`),
            features: {
              crew_access: formData.get(`aid_crew_${i}`) === 'on',
              drop_bag: formData.get(`aid_dropbag_${i}`) === 'on',
              full_aid: formData.get(`aid_fullaid_${i}`) === 'on',
              medical: formData.get(`aid_medical_${i}`) === 'on'
            },
            estimated_stop_seconds: parseInt(formData.get(`aid_estimated_${i}`)) || 0,
            target_stop_seconds: parseInt(formData.get(`aid_target_${i}`)) || 0,
            cutoff_time: formData.get(`aid_cutoff_${i}`) || "",
            buffer_to_cutoff_min: parseInt(formData.get(`aid_buffer_${i}`)) || 0,
            crew_instructions: formData.get(`aid_crew_instructions_${i}`) || "",
            notes: formData.get(`aid_notes_${i}`) || ""
          };
          profile.aid_stations.push(station);
        }
      }

      // Collect segments
      for (let i = 1; i <= segmentCount; i++) {
        if (document.getElementById(`segment-${i}`)) {
          const segment = {
            name: formData.get(`seg_name_${i}`),
            start_km: parseFloat(formData.get(`seg_start_${i}`)),
            end_km: parseFloat(formData.get(`seg_end_${i}`)),
            difficulty_rating: formData.get(`seg_difficulty_${i}`),
            description: formData.get(`seg_description_${i}`) || "",
            strategy_notes: formData.get(`seg_strategy_${i}`) || ""
          };
          profile.key_segments.push(segment);
        }
      }

      // Display JSON
      generatedJSON = profile;
      document.getElementById('jsonOutput').textContent = JSON.stringify(profile, null, 2);
    }

    function copyJSON() {
      if (!generatedJSON) {
        alert('Please generate JSON first!');
        return;
      }

      const text = JSON.stringify(generatedJSON, null, 2);
      navigator.clipboard.writeText(text).then(() => {
        alert('JSON copied to clipboard!');
      });
    }

    function downloadJSON() {
      if (!generatedJSON) {
        alert('Please generate JSON first!');
        return;
      }

      const text = JSON.stringify(generatedJSON, null, 2);
      const blob = new Blob([text], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${generatedJSON.course_metadata.race_id}_course_profile_v1_0.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Add initial aid station and segment
    window.onload = () => {
      addAidStation();
      addSegment();
    };
  </script>
</body>
</html>
